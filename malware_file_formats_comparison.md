# Malware File Format Comparison Guide

## Introduction

Malware authors leverage various file formats to deliver and execute malicious code. Understanding how different file formats can be weaponized is crucial for malware analysts and security professionals. This guide provides a comprehensive comparison of common file formats used in malware delivery, their exploitation techniques, and analysis approaches.

## 1. Portable Executable (PE) Files

### Overview
PE files (.exe, .dll, .sys) are the native executable format for Windows and the most common format for malware delivery.

### Malware Techniques
- **Packers/Crypters**: UPX, Themida, custom packers to obfuscate code
- **Anti-Analysis**: Anti-debugging, anti-VM, timing checks
- **Process Injection**: Reflective DLL injection, process hollowing
- **Import Address Table (IAT) Manipulation**: Hiding API calls
- **Resource Section Abuse**: Storing encrypted payloads in resources

### Analysis Approach
- **Static Analysis Tools**: PE Explorer, PEStudio, DIE (Detect It Easy)
- **Dynamic Analysis**: Process Monitor, API monitoring
- **Debugging**: x64dbg, IDA Pro, Ghidra
- **Unpacking Techniques**: Manual unpacking, automated unpackers

### Example Malware Families
- Emotet, TrickBot, Qakbot, Formbook, Agent Tesla

## 2. Office Documents

### Overview
Microsoft Office files (.doc, .docm, .xls, .xlsm, .ppt) are commonly used in phishing campaigns.

### Malware Techniques
- **VBA Macros**: Obfuscated macros that execute on document open
- **DDE (Dynamic Data Exchange)**: Formula fields that execute commands
- **Embedded Objects**: OLE objects containing exploits
- **Exploits**: Memory corruption vulnerabilities (e.g., CVE-2017-11882)
- **XLM Macros**: Legacy Excel 4.0 macros for evasion

### Analysis Approach
- **Static Analysis Tools**: olevba, oledump, XLMMacroDeobfuscator
- **Dynamic Analysis**: Office sandbox environments
- **Macro Extraction**: Using olevba, oletools suite
- **Content Analysis**: Examining embedded objects and links

### Example Malware Families
- Emotet, Qakbot, Dridex, Ursnif, IcedID

## 3. PDF Files

### Overview
PDF files can contain JavaScript, forms, and embedded files that can be exploited.

### Malware Techniques
- **JavaScript Exploitation**: Heap spraying, vulnerability exploitation
- **Embedded Files**: Malicious files executed from PDF
- **URI Handling**: Malicious URL execution
- **Form Submission**: Exfiltrating data via form submission
- **Encryption**: Hiding malicious content using encryption

### Analysis Approach
- **Static Analysis Tools**: pdfid.py, pdf-parser.py, peepdf
- **JavaScript Analysis**: Extracting and deobfuscating JavaScript
- **Object Stream Analysis**: Examining embedded objects
- **Vulnerability Identification**: Matching exploit patterns

### Example Malware Families
- PDF Exploiter, PDFex, Nitro, JSPdf

## 4. Archive Files

### Overview
Archive files (.zip, .rar, .7z, .iso) are used to bypass email filters and hide malicious content.

### Malware Techniques
- **Password Protection**: Simple passwords shared in email body
- **Nested Archives**: Multiple layers of archives to evade detection
- **Hidden Extensions**: Using Unicode characters or right-to-left override
- **ISO/IMG Files**: Mounting as drives to bypass Mark-of-the-Web protections
- **Self-Extracting Archives**: Automatic execution after extraction

### Analysis Approach
- **Static Analysis**: Examining archive structure without extraction
- **Content Inspection**: Checking file types within archives
- **Password Cracking**: When archives are password-protected
- **Signature Detection**: Identifying known malicious archives

### Example Malware Families
- AsyncRAT, NanoCore, Remcos, Redline Stealer

## 5. Script Files

### Overview
Script files (.js, .vbs, .ps1, .hta, .bat) are lightweight and versatile for malware delivery.

### Malware Techniques
- **Obfuscation**: Heavy string manipulation and encoding
- **Living-off-the-Land**: Using built-in Windows tools
- **Fileless Execution**: Running directly in memory
- **Staged Downloading**: Scripts that download additional payloads
- **WMI/PowerShell Abuse**: For persistence and execution

### Analysis Approach
- **Deobfuscation**: Manual or automated script deobfuscation
- **Behavioral Analysis**: Monitoring script execution
- **String Extraction**: Identifying embedded commands and URLs
- **Emulation**: Running scripts in controlled environments

### Example Malware Families
- Lokibot, AgentTesla, FormBook, AsyncRAT

## 6. LNK Files (Shortcuts)

### Overview
Windows shortcut files that can execute commands when opened.

### Malware Techniques
- **Command Line Abuse**: Executing PowerShell or cmd commands
- **Icon Path Abuse**: Loading malicious DLLs via icon paths
- **Target Path Manipulation**: Pointing to malicious executables
- **Environmental Variable Abuse**: Using %COMSPEC% and other variables
- **NTFS Alternate Data Streams**: Hiding data in ADS

### Analysis Approach
- **LNK Parsing**: Using tools like lnk_parser.py
- **Command Line Extraction**: Analyzing embedded commands
- **Target Analysis**: Examining the shortcut target
- **Icon Resource Analysis**: Checking for malicious icon resources

### Example Malware Families
- Emotet, QakBot, IcedID, BitRAT

## 7. HTML Applications (HTA)

### Overview
HTML applications (.hta) combine HTML and scripting languages with full system access.

### Malware Techniques
- **ActiveX Controls**: Executing privileged code
- **VBScript/JScript**: Obfuscated scripts for payload execution
- **PowerShell Execution**: Launching PowerShell commands
- **UAC Bypass**: Techniques to elevate privileges
- **Fileless Techniques**: In-memory execution

### Analysis Approach
- **HTML/Script Parsing**: Extracting embedded scripts
- **Deobfuscation**: Revealing hidden code
- **Behavioral Analysis**: Monitoring execution flow
- **ActiveX Analysis**: Identifying malicious ActiveX objects

### Example Malware Families
- Hancitor, SocGholish, AsyncRAT, Formbook

## 8. Android Package Kit (APK)

### Overview
Android application package files that can contain malicious code.

### Malware Techniques
- **Permission Abuse**: Requesting excessive permissions
- **Repackaging**: Legitimate apps with added malicious code
- **Dynamic Code Loading**: Loading malicious code at runtime
- **Native Code Exploitation**: Using native libraries for evasion
- **SMS Interception**: Stealing 2FA codes and communications

### Analysis Approach
- **Static Analysis**: APKTool, JADX for decompilation
- **Manifest Analysis**: Examining AndroidManifest.xml
- **Dynamic Analysis**: Monitoring API calls and network traffic
- **Behavioral Analysis**: Sandbox execution and monitoring

### Example Malware Families
- Anubis, Joker, FluBot, TeaBot, Cerberus

## 9. ELF (Executable and Linkable Format)

### Overview
Native executable format for Linux systems, used in IoT and server malware.

### Malware Techniques
- **Process Injection**: Injecting code into running processes
- **Shared Library Hijacking**: Abusing LD_PRELOAD
- **Anti-Analysis**: Detecting debuggers and virtual environments
- **Rootkit Techniques**: Hiding processes and files
- **Persistence**: Init scripts, cron jobs, service files

### Analysis Approach
- **Static Analysis**: Readelf, objdump, Ghidra
- **Dynamic Analysis**: Strace, ltrace, gdb
- **Memory Forensics**: Volatility for Linux memory analysis
- **Network Analysis**: Monitoring C2 communications

### Example Malware Families
- Mirai, XorDDoS, Kaiji, Tsunami, Gafgyt

## 10. ISO/IMG Disk Images

### Overview
Disk image files that can be mounted as virtual drives in Windows.

### Malware Techniques
- **Mark-of-the-Web Bypass**: Mounted ISOs don't inherit MOTW flags
- **AutoRun Abuse**: Automatic execution when mounted
- **LNK + ISO Combination**: Shortcuts within ISOs for execution
- **Hidden Malicious Files**: Concealing executables within image structure
- **Social Engineering**: Appearing as legitimate software installers

### Analysis Approach
- **Image Mounting**: In isolated environments
- **Content Analysis**: Examining files within the image
- **Structural Analysis**: Checking for hidden sectors or files
- **Behavioral Analysis**: Monitoring system changes upon mounting

### Example Malware Families
- IcedID, Bazar Loader, SocGholish, Qakbot

## Comparative Analysis

| File Format | Prevalence | Evasion Potential | Analysis Difficulty | Common Delivery Method |
|-------------|------------|-------------------|---------------------|------------------------|
| PE (.exe, .dll) | Very High | High | Medium | Direct download, Drive-by |
| Office Documents | Very High | High | Medium | Email attachments |
| PDF | Medium | Medium | Medium | Email attachments, Web |
| Archives | High | Medium | Low | Email attachments |
| Scripts | High | Very High | Medium | Email, Web downloads |
| LNK | Medium | High | Low | Email, Archives |
| HTA | Medium | High | Medium | Web downloads |
| APK | Medium | Medium | Medium | App stores, Direct download |
| ELF | Medium | Medium | High | Vulnerable servers, IoT |
| ISO/IMG | Increasing | High | Low | Email, Web downloads |

## Detection Strategies

### 1. Static Detection
- **Signatures**: YARA rules for known patterns
- **Heuristics**: Identifying suspicious characteristics
- **Metadata Analysis**: Examining file properties and structure
- **Entropy Analysis**: Detecting packed or encrypted content

### 2. Dynamic Detection
- **Behavioral Analysis**: Monitoring execution behavior
- **Sandboxing**: Executing files in isolated environments
- **API Monitoring**: Tracking suspicious API calls
- **Memory Analysis**: Examining process memory for indicators

### 3. Network Detection
- **Traffic Analysis**: Monitoring for C2 communications
- **DNS Monitoring**: Detecting suspicious domain resolutions
- **TLS Inspection**: Examining encrypted traffic patterns
- **Proxy Filtering**: Blocking known malicious domains

## Conclusion

Understanding the various file formats used for malware delivery is essential for effective security analysis and defense. Each format presents unique challenges and requires specific analysis techniques. By familiarizing yourself with these formats and their exploitation methods, you can better prepare for identifying and mitigating malware threats across different platforms and environments.

## References

1. MITRE ATT&CK, "Initial Access Techniques", https://attack.mitre.org/tactics/TA0001/
2. FireEye, "M-Trends 2023: The Evolution of Malware Delivery Techniques"
3. Microsoft Security Intelligence Report, "File Format Exploitation Trends"
4. SANS Institute, "Malware Analysis Fundamentals", 2022
5. Mandiant, "Red Team File Format Abuse Techniques", 2023
