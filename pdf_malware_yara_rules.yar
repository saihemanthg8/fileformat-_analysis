/*
  YARA Rules for Detecting Malicious PDF Files
  Author: [Your Name]
  Date: [Current Date]
  Description: This file contains YARA rules for detecting various types of malicious PDF files
*/

import "pe"
import "hash"

rule Suspicious_PDF_JavaScript_Exploitation {
    meta:
        description = "Detects potential PDF JavaScript exploitation techniques"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        hash = "8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f4fb6b7c53e73c3a"
        severity = "High"
    
    strings:
        $pdf_header = "%PDF"
        
        // JavaScript related tags
        $js_tag1 = "/JavaScript" nocase
        $js_tag2 = "/JS" nocase
        $openaction = "/OpenAction" nocase
        $aa_tag = "/AA" nocase
        
        // Suspicious JavaScript functions
        $suspicious_js1 = "unescape" nocase
        $suspicious_js2 = "eval" nocase
        $suspicious_js3 = "collectGarbage" nocase
        $suspicious_js4 = "shellcode" nocase
        $suspicious_js5 = "substring" nocase
        $suspicious_js6 = "fromCharCode" nocase
        $suspicious_js7 = "String.fromCharCode" nocase
        
        // Heap spray related
        $heap1 = "NOP" nocase
        $heap2 = "%u9090" nocase
        $heap3 = "heap" nocase fullword
        $heap4 = "spray" nocase fullword
        
        // Obfuscation techniques
        $obfuscation1 = "charAt" nocase
        $obfuscation2 = "charCodeAt" nocase
        $obfuscation3 = "substring" nocase
        $obfuscation4 = "replace" nocase
        $obfuscation5 = "split" nocase
        $obfuscation6 = "slice" nocase
        
        // RC4 encryption
        $rc4_1 = "function rc4" nocase
        $rc4_2 = "var s = [], j = 0" nocase
        
    condition:
        $pdf_header at 0 and
        (($js_tag1 or $js_tag2) and ($openaction or $aa_tag)) and
        (
            (2 of ($suspicious_js*)) or
            (any of ($heap*) and any of ($suspicious_js*)) or
            (any of ($rc4*) and 2 of ($obfuscation*)) or
            (3 of ($obfuscation*) and any of ($suspicious_js*))
        )
}

rule PDF_CVE_2023_21608_Exploit {
    meta:
        description = "Detects PDF files exploiting CVE-2023-21608 (Adobe Reader JavaScript Engine UAF)"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "https://helpx.adobe.com/security/products/acrobat/apsb23-34.html"
        hash = "8a1e0c5a1a01c4d3b4a16585cc7ecc5f3879aa9e4f4a6b35f4fb6b7c53e73c3a"
        severity = "Critical"
    
    strings:
        $pdf_header = "%PDF"
        
        // JavaScript related tags
        $js_tag = "/JavaScript" nocase
        $openaction = "/OpenAction" nocase
        
        // Specific exploitation patterns for CVE-2023-21608
        $exploit1 = "delete target.prop" nocase
        $exploit2 = "collectGarbage" nocase
        $exploit3 = "toString" nocase
        $exploit4 = "repeat" nocase
        $exploit5 = "new Object()" nocase
        $exploit6 = "prop =" nocase
        
        // Shellcode indicators
        $shellcode1 = "VirtualAlloc" nocase
        $shellcode2 = "URLDownloadToFile" nocase
        $shellcode3 = "WinExec" nocase
        $shellcode4 = "ExitProcess" nocase
        
    condition:
        $pdf_header at 0 and
        $js_tag and $openaction and
        (
            (3 of ($exploit*)) or
            (2 of ($exploit*) and 1 of ($shellcode*)) or
            (4 of ($exploit*) and $shellcode1 and $shellcode2)
        )
}

rule PDF_Embedded_Executable {
    meta:
        description = "Detects PDF files with embedded executable content"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        severity = "Medium"
    
    strings:
        $pdf_header = "%PDF"
        
        // PDF objects and filters
        $obj = "obj" nocase
        $endobj = "endobj" nocase
        $stream = "stream" nocase
        $endstream = "endstream" nocase
        $filter = "/Filter" nocase
        $flatedecode = "/FlateDecode" nocase
        
        // PE file headers that might be embedded
        $mz = "MZ"
        $pe = "PE\x00\x00"
        $dos_stub = "This program cannot be run in DOS mode"
        
        // Common executable strings
        $exe1 = ".exe" nocase
        $exe2 = "This program" nocase
        $exe3 = "GetProcAddress" nocase
        $exe4 = "LoadLibrary" nocase
        $exe5 = "kernel32.dll" nocase
        $exe6 = "user32.dll" nocase
        
    condition:
        $pdf_header at 0 and
        all of ($obj, $endobj, $stream, $endstream) and
        (
            ($mz and $pe) or
            ($mz and $dos_stub) or
            (2 of ($exe*) and $filter and $flatedecode)
        )
}

rule PDF_Suspicious_URI_Actions {
    meta:
        description = "Detects PDF files with suspicious URI actions"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        severity = "Medium"
    
    strings:
        $pdf_header = "%PDF"
        
        // URI action related
        $uri_action = "/URI" nocase
        $launch_action = "/Launch" nocase
        $submit_form = "/SubmitForm" nocase
        
        // Suspicious domains or patterns
        $suspicious_domain1 = "financial-reports-cdn" nocase
        $suspicious_domain2 = "analytics-server" nocase
        $suspicious_domain3 = ".ru" nocase
        $suspicious_domain4 = ".cn" nocase
        $suspicious_domain5 = ".xyz" nocase
        $suspicious_domain6 = ".top" nocase
        
        // Suspicious URI patterns
        $suspicious_uri1 = "http://" nocase
        $suspicious_uri2 = "https://" nocase
        $suspicious_uri3 = "ftp://" nocase
        $suspicious_uri4 = "/updates/" nocase
        $suspicious_uri5 = "/download" nocase
        $suspicious_uri6 = "/api/" nocase
        
    condition:
        $pdf_header at 0 and
        ($uri_action or $launch_action or $submit_form) and
        (
            (1 of ($suspicious_domain*) and 1 of ($suspicious_uri*)) or
            (2 of ($suspicious_domain*)) or
            (3 of ($suspicious_uri*))
        )
}

rule PDF_Suspicious_JavaScript_Obfuscation {
    meta:
        description = "Detects heavily obfuscated JavaScript in PDF files"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        severity = "Medium"
    
    strings:
        $pdf_header = "%PDF"
        
        // JavaScript related tags
        $js_tag = "/JavaScript" nocase
        
        // Array-based obfuscation
        $array_obfuscation1 = "var _0x" nocase
        $array_obfuscation2 = "=['" nocase
        $array_obfuscation3 = "[0]" nocase
        $array_obfuscation4 = "[1]" nocase
        
        // String manipulation for obfuscation
        $string_manipulation1 = "charAt" nocase
        $string_manipulation2 = "charCodeAt" nocase
        $string_manipulation3 = "fromCharCode" nocase
        $string_manipulation4 = "substring" nocase
        $string_manipulation5 = "slice" nocase
        $string_manipulation6 = "replace" nocase
        
        // Suspicious eval patterns
        $eval1 = "eval(" nocase
        $eval2 = "Function(" nocase
        $eval3 = "new Function" nocase
        
    condition:
        $pdf_header at 0 and
        $js_tag and
        (
            (2 of ($array_obfuscation*) and 2 of ($string_manipulation*)) or
            (any of ($eval*) and 3 of ($string_manipulation*)) or
            (3 of ($array_obfuscation*)) or
            (4 of ($string_manipulation*))
        )
}

rule PDF_Malicious_Form_Submission {
    meta:
        description = "Detects PDF files with suspicious form submission actions"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        severity = "Medium"
    
    strings:
        $pdf_header = "%PDF"
        
        // Form related tags
        $acroform = "/AcroForm" nocase
        $xfa = "/XFA" nocase
        $submit_form = "/SubmitForm" nocase
        
        // Suspicious submission URLs
        $suspicious_url1 = "http://" nocase
        $suspicious_url2 = "https://" nocase
        $suspicious_url3 = ".php" nocase
        $suspicious_url4 = ".aspx" nocase
        $suspicious_url5 = "data.php" nocase
        $suspicious_url6 = "submit.php" nocase
        $suspicious_url7 = "form.php" nocase
        
    condition:
        $pdf_header at 0 and
        ($acroform or $xfa) and $submit_form and
        2 of ($suspicious_url*)
}

rule PDF_Suspicious_Embedded_File {
    meta:
        description = "Detects PDF files with suspicious embedded files"
        author = "[Your Name]"
        date = "2023-12-01"
        reference = "Internal Research"
        severity = "Medium"
    
    strings:
        $pdf_header = "%PDF"
        
        // Embedded file related tags
        $embedded_file = "/EmbeddedFile" nocase
        $filespec = "/FileSpec" nocase
        
        // Suspicious file extensions
        $suspicious_ext1 = ".exe" nocase
        $suspicious_ext2 = ".dll" nocase
        $suspicious_ext3 = ".bat" nocase
        $suspicious_ext4 = ".vbs" nocase
        $suspicious_ext5 = ".ps1" nocase
        $suspicious_ext6 = ".js" nocase
        $suspicious_ext7 = ".hta" nocase
        
    condition:
        $pdf_header at 0 and
        ($embedded_file or $filespec) and
        1 of ($suspicious_ext*)
}
